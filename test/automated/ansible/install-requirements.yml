---

- hosts: testing_hosts_linux
  become: true
  gather_facts: no

  tasks:
    - name: Remove EOL repository sources
      include_role:
        name: remove-eol-sources

    - name: Configure OpenSUSE repositories when needed
      include_role:
        name: opensuse-repositories

    - name: re-install rpm
      include_role:
        name: reinstall-rpm

    # Install python3 as crowdstrike falcon via Ansible requires it
    - name: install python3
      include_role:
        name: install-python

    - name: Install Libcap
      include_role:
        name: install-libcap

    - name: Install GPG
      include_role:
        name: install-gpg

# CrowdStrike Falcon install
- hosts: testing_hosts_linux
  become: true
  gather_facts: yes
  tasks:
    # Install python
    - name: install python3
      include_role:
        name: install-python
    - name: ensure pip3 is installed
      include_role:
        name: ensure-pip
    # Crowdstrike reqs
    - name: install cloudstrike-falconpy
      raw: '/usr/bin/env python3 -m pip install crowdstrike-falconpy'
      when: ansible_facts['os_family'] != 'Windows'
    - name: install cloudstrike-falconpy
      raw: 'python3 -m pip install crowdstrike-falconpy'
      when: ansible_facts['os_family'] == 'Windows'

- hosts: testing_hosts_linux
  become: true
  gather_facts: yes
  tasks:
    - name: Configure logrotate
      include_role:
        name: logrotate

    - name: Configure hostname
      include_role:
        name: hostname

- hosts: testing_hosts_macos
  become: false
  gather_facts: yes
  tasks:
    - name: install brew
      include_role:
        name: install-brew
        # latest versions of brew allow running service with sudo, not necessary to downgrade
        # comment left for reference
#      vars:
#        brew_version: 3.6.21 # with 4.0.* there are some problems with sudo https://github.com/Homebrew/brew/issues/14462#issuecomment-1445130069
    - name: install python
      include_role:
        name: install-python
    # Crowdstrike reqs
    - name: install cloudstrike-falconpy
      ansible.builtin.pip:
        name: crowdstrike-falconpy

- hosts: testing_hosts_windows
  become: true
  become_method: runas
  become_user: Administrator
  gather_facts: yes
  tasks:
    # Install python
    - name: install python
      include_role:
        name: install-python
    # Crowdstrike reqs
    - name: install cloudstrike-falconpy
      ansible.builtin.pip:
        name: crowdstrike-falconpy

- hosts: testing_hosts_windows
  gather_facts: yes
  tasks:
    - name: Configure hostname
      include_role:
        name: hostname

# Install CrowdStrike Falcon
- hosts: testing_hosts
  gather_facts: yes
  vars:
    falcon_client_id: "{{ crowdstrike_client_id }}"
    falcon_client_secret: "{{ crowdstrike_client_secret }}"
  roles:
    - role: crowdstrike.falcon.falcon_install
    - role: crowdstrike.falcon.falcon_configure