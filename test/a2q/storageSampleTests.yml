apiVersion: v1
kind: TestSuite
metadata:
  name: StorageSample - MELT
  namespace: infra-agent
  team: OHAI
  owningTeam: OHAI
  environment: ${var.sutEnvironment}
  x-category: melt
  x-period: 5m
spec:
  tests:
    - nrql: "FROM StorageSample SELECT agentName WHERE displayName = '${var.display_name_current}' LIMIT 1"
      name: Check agent name current
      account: ${var.accountId}
      apiKey: ${secret.apiKey}
      nrEnv: ${var.nrEnv}
      assertions:
        - fields: "agentName"
          equals: "Infrastructure"
    - nrql: "FROM StorageSample SELECT agentName WHERE displayName = '${var.display_name_previous}' LIMIT 1"
      name: Check agent name previous
      account: ${var.accountId}
      apiKey: ${secret.apiKey}
      nrEnv: ${var.nrEnv}
      assertions:
        - fields: "agentName"
          equals: "Infrastructure"
    - nrql: "SELECT abs(filter(average(diskUsedBytes), WHERE displayName = '${var.display_name_current}') - filter(average(diskUsedBytes), WHERE displayName = '${var.display_name_previous}')) AS 'Disk Used Bytes Difference' FROM StorageSample SINCE 5 minutes AGO"
      name: Disk Used Bytes Difference
      account: ${var.accountId}
      apiKey: ${secret.apiKey}
      nrEnv: ${var.nrEnv}
      assertions:
        - fields: "['Disk Used Bytes Difference']"
          greater: 1000000000
    - nrql: "SELECT abs(filter(average(diskUsedPercent), WHERE displayName = '${var.display_name_current}') - filter(average(diskUsedPercent), WHERE displayName = '${var.display_name_previous}')) AS 'Disk Used Percent Difference' FROM StorageSample SINCE 5 minutes AGO"
      name: Disk Used Percent Difference
      account: ${var.accountId}
      apiKey: ${secret.apiKey}
      nrEnv: ${var.nrEnv}
      assertions:
        - fields: "['Disk Used Percent Difference']"
          greater: 0.5
    - nrql: "SELECT abs(filter(average(diskFreeBytes), WHERE displayName = '${var.display_name_current}') - filter(average(diskFreeBytes), WHERE displayName = '${var.display_name_previous}')) AS 'Disk Free Bytes Difference' FROM StorageSample SINCE 5 minutes AGO"
      name: Disk Free Bytes Difference
      account: ${var.accountId}
      apiKey: ${secret.apiKey}
      nrEnv: ${var.nrEnv}
      assertions:
        - fields: "['Disk Free Bytes Difference']"
          greater: 500000000
    - nrql: "SELECT abs(filter(average(diskFreePercent), WHERE displayName = '${var.display_name_current}') - filter(average(diskFreePercent), WHERE displayName = '${var.display_name_previous}')) AS 'Disk Free Percent Difference' FROM StorageSample SINCE 5 minutes AGO"
      name: Disk Free Percent Difference
      account: ${var.accountId}
      apiKey: ${secret.apiKey}
      nrEnv: ${var.nrEnv}
      assertions:
        - fields: "['Disk Free Percent Difference']"
          greater: 5
    - nrql: "SELECT abs(filter(average(diskTotalBytes), WHERE displayName = '${var.display_name_current}') - filter(average(diskTotalBytes), WHERE displayName = '${var.display_name_previous}')) AS 'Disk Total Bytes Difference' FROM StorageSample SINCE 5 minutes AGO"
      name: Disk Total Bytes Difference
      account: ${var.accountId}
      apiKey: ${secret.apiKey}
      nrEnv: ${var.nrEnv}
      assertions:
        - fields: "['Disk Total Bytes Difference']"
          less: 10000
    - nrql: "SELECT abs(filter(average(inodesUsed), WHERE displayName = '${var.display_name_current}') - filter(average(inodesUsed), WHERE displayName = '${var.display_name_previous}')) AS 'Inodes Used Difference' FROM StorageSample SINCE 5 minutes AGO"
      name: Inodes Used Difference
      account: ${var.accountId}
      apiKey: ${secret.apiKey}
      nrEnv: ${var.nrEnv}
      assertions:
        - fields: "['Inodes Used Difference']"
          greater: 5000
    - nrql: "SELECT abs(filter(average(inodesFree), WHERE displayName = '${var.display_name_current}') - filter(average(inodesFree), WHERE displayName = '${var.display_name_previous}')) AS 'Inodes Free Difference' FROM StorageSample SINCE 5 minutes AGO"
      name: Inodes Free Difference
      account: ${var.accountId}
      apiKey: ${secret.apiKey}
      nrEnv: ${var.nrEnv}
      assertions:
        - fields: "['Inodes Free Difference']"
          greater: 50000
    - nrql: "SELECT abs(filter(average(inodesTotal), WHERE displayName = '${var.display_name_current}') - filter(average(inodesTotal), WHERE displayName = '${var.display_name_previous}')) AS 'Inodes Total Difference' FROM StorageSample SINCE 5 minutes AGO"
      name: Inodes Total Difference
      account: ${var.accountId}
      apiKey: ${secret.apiKey}
      nrEnv: ${var.nrEnv}
      assertions:
        - fields: "['Inodes Total Difference']"
          greater: 1
    - nrql: "SELECT abs(filter(average(inodesUsedPercent), WHERE displayName = '${var.display_name_current}') - filter(average(inodesUsedPercent), WHERE displayName = '${var.display_name_previous}')) AS 'Inodes Used Percent Difference' FROM StorageSample SINCE 5 minutes AGO"
      name: Inodes Used Percent Difference
      account: ${var.accountId}
      apiKey: ${secret.apiKey}
      nrEnv: ${var.nrEnv}
      assertions:
        - fields: "['Inodes Used Percent Difference']"
          greater: 0.1