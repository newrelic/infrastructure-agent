TARGET ?= integration_payload

.PHONY: all
all: install update-corpus build_and_run

.PHONY: build_and_run
build_and_run: build clean run

.PHONY: install
install:
	@go get -u github.com/dvyukov/go-fuzz/go-fuzz github.com/dvyukov/go-fuzz/go-fuzz-build

.PHONY: build
build:
	@go-fuzz-build -o test/fuzz/${TARGET}/bin/fuzz.zip github.com/newrelic/infrastructure-agent/test/fuzz/${TARGET}

.PHONY: clean
clean:
	@rm -rf test/fuzz/${TARGET}/workdir/*
	@mkdir test/fuzz/${TARGET}/workdir/corpus
	@cp test/fuzz/${TARGET}/corpus/* test/fuzz/${TARGET}/workdir/corpus

.PHONY: run
run:
	@echo "Fuzzing ${TARGET}..."
	@go-fuzz -bin=test/fuzz/${TARGET}/bin/fuzz.zip -workdir=test/fuzz/${TARGET}/workdir

.PHONY: update-corpus
update-corpus:
	# only agent config corpus is automatically updated for now
	# disclaimer: this config does not handle types correctly
	# once we provide a full sample config to users, that one should be injected here
	@grep -w 'yaml:' pkg/config/config.go |awk -F'"' '{print $$2": 1"}' > test/fuzz/config_load/corpus/autogenerated.yaml
