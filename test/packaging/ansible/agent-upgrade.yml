---

- hosts: all
  become: true
  gather_facts: yes

  pre_tasks:
    - name: initial cleanup # Only required for shared infra.
      include_role:
        name: cleanup

  tasks:
    - name: agent upgrade tests suite
      vars:
        agent_pkg_version: "1.18.2" # TODO : Change it to specific version before merging to master
        env_vars:

      block:

        - name: install initial version
          include_role:
            name: agent-install

        - name: get current agent PID
          command: pgrep -x newrelic-infra
          register: agent_pid

        - name: upgrade agent
          include_role:
            name: agent-upgrade

        - name: assert service countinues running after upgrade
          include_role:
            name: assert-service

        - name: get current agent PID
          command: pgrep -x newrelic-infra
          register: updated_agent_pid

        - name: assert agent has been reloaded
          assert:
            that: agent_pid.stdout != updated_agent_pid.stdout

      always:
        - name: Final cleanup # Only required for shared infra.
          include_role:
            name: cleanup


...
