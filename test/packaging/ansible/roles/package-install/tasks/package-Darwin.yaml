- name: register brew path
  shell: "echo '/opt/homebrew/bin/brew'"
  register: brew_path
  when: ansible_architecture == "arm64"

- name: register brew path
  shell: "echo '/usr/local/bin/brew'"
  register: brew_path
  when: ansible_architecture == "x86_64"

- name: Stop launchctl service
  command: "{{ brew_path }} services stop newrelic-infra-agent"
  ignore_errors: yes

- name: Agent uninstall
  become: false
  command: "{{ brew_path }} uninstall --force newrelic-infra-agent"
  ignore_errors: yes

- name: cleanup | Remove files
  command: rm -rf /usr/local/Cellar/newrelic-infra-agent

  # Avoid errors with commit hash on tag recreation
- name: delete brew cache (avoid tag recreation commit error)
  file:
    path: "/Users/{{ ansible_user }}/Library/Caches/Homebrew"
    state: absent

- name: Install agent
  become: false
  command: "{{ brew_path }}  reinstall --formula --build-from-source /Users/{{ ansible_user }}/newrelic-infra-agent.rb"

- name: Start launchctl service
  command: "{{ brew_path }} services start newrelic-infra-agent"
