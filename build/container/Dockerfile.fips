# FIPS compliant base image
ARG base_image=cf-registry.nr-ops.net/newrelic/base-ubuntu:22.04-fips

FROM $base_image AS core

ARG image_version=0.0
ARG agent_version=0.0
ARG version_file=VERSION
ARG agent_bin=newrelic-infra

# Add the agent binary
COPY $agent_bin /usr/bin/newrelic-infra
COPY ${agent_bin}-ctl /usr/bin/newrelic-infra-ctl
COPY ${agent_bin}-service /usr/bin/newrelic-infra-service

# Add all static assets
COPY assets /newrelic

# Add the VERSION file
COPY $version_file /newrelic/VERSION

LABEL com.newrelic.image.version=$image_version \
      com.newrelic.infra-agent.version=$agent_version \
      com.newrelic.maintainer="infrastructure-eng@newrelic.com" \
      com.newrelic.description="FIPS Compliant New Relic Infrastructure agent for monitoring the underlying host."

ENV NRIA_IS_CONTAINERIZED=true
ENV NRIA_OVERRIDE_HOST_ROOT=/host

RUN apt-get update && apt-get upgrade -y

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    tini \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Tini is now available at /sbin/tini
ENTRYPOINT ["/sbin/tini", "--"]
CMD ["/usr/bin/newrelic-infra-service"]

#################################
# Forwarder
#################################
FROM core AS forwarder

RUN apt-get update && apt-get install -y --no-install-recommends \
        curl \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

RUN addgroup --gid 2000 nri-agent && adduser -D -H -u 1000 -G nri-agent nri-agent
USER nri-agent

ENV NRIA_OVERRIDE_HOST_ROOT=""
ENV NRIA_IS_SECURE_FORWARD_ONLY=true

#################################
# K8s events forwarder
#################################
FROM forwarder AS k8s-events-forwarder

ENV NRIA_HTTP_SERVER_ENABLED=true

#################################
# BASE
#################################
FROM core AS base

ARG nri_pkg_dir
ARG nri_docker_version
ARG nri_flex_version
ARG nri_prometheus_version

LABEL com.newrelic.nri-docker.version=$nri_docker_version \
      com.newrelic.nri-flex.version=$nri_flex_version \
      com.newrelic.nri-prometheus.version=$nri_prometheus_version

RUN apt-get update && apt-get install -y --no-install-recommends \
        ntp \
        curl \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

COPY $nri_pkg_dir /
