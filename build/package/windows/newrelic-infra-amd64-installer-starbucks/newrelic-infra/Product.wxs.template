<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <?define Version = "{AgentVersion}" ?>
  <?define ProductId = "*" ?>
  <?define UpgradeCode = "{527b3f06-b23d-426a-9999-c77506ee6b28}" ?>

	<Product Id="$(var.ProductId)"
        Name="New Relic Infrastructure Agent"
        Language="1033"
        Version="$(var.Version)"
        Manufacturer="New Relic, Inc."
        UpgradeCode="$(var.UpgradeCode)">
		<Package Id="*"
          InstallerVersion="200"
          Compressed="yes"
          InstallScope="perMachine"
          Platform="x64"
          Manufacturer="New Relic, Inc."
          Comments="(c) 2018 New Relic, Inc."
          Keywords="infrastructure,agent,MSI"/>

		<MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
		<MediaTemplate EmbedCab="yes" />

        <Property Id="LICENSE_KEY" Secure="yes" />
        <Property Id="DISPLAY_NAME" Secure="yes" />
        <Property Id="PROXY"  Secure="yes" />
        <Property Id="CUSTOM_ATTRIBUTES" Secure="yes" />
        <Property Id="METRICS_SYSTEM_SAMPLE_RATE"  Secure="yes" />
        <Property Id="METRICS_STORAGE_SAMPLE_RATE"  Secure="yes" />
        <Property Id="METRICS_NETWORK_SAMPLE_RATE"  Secure="yes" />
        <Property Id="METRICS_PROCESS_SAMPLE_RATE"  Secure="yes" />
        <Property Id="PAYLOAD_COMPRESSION_LEVEL"  Secure="yes" />

		<Feature Id="ProductFeature" Title="New Relic Infrastructure Agent" Level="1">
            <ComponentRef Id="CMP_V1_PLUGIN_CONFIGS" />
            <ComponentRef Id="CMP_V1_CUSTOM_PLUGINS" />
            <ComponentRef Id="CMP_V1_NR_PLUGINS" />
            <ComponentRef Id="CMP_LOGGING_TOOL" />
            <ComponentRef Id="CMP_LOGGING_TOOL_CFG" />
			<ComponentGroupRef Id="ProductComponents" />
			<ComponentGroupRef Id="BundledPluginDefinitionComponents" />
			<ComponentGroupRef Id="BundledPluginConfigComponents" />
			<ComponentGroupRef Id="BundledPluginComponents" />
            <?if "$(var.IncludeFluentBit)" = "True"?>
			  <ComponentGroupRef Id="LoggingToolComponents" />
			  <ComponentGroupRef Id="LoggingToolCfgComponents" />
			<?endif?>
		</Feature>
	</Product>

	<Fragment>
		<Directory Id="TARGETDIR" Name="SourceDir">
			<Directory Id="ProgramFiles64Folder">
        <Directory Id="CompanyFolder" Name="New Relic">
          <Directory Id="AgentBinaryFolder" Name="newrelic-infra">
            <Directory Id="DataFolder" Name="data" />
            <Directory Id="UserDataFolder" Name="user_data" />
            <Directory Id="PluginsFolder" Name="plugins" />
            <Directory Id="BundledPluginsFolder" Name="bundled-plugins" />
            <Directory Id="V1PluginConfigsFolder" Name="integrations.d" />
            <Directory Id="LoggingToolCfg" Name="logging.d" />
            <Directory Id="V1CustomPluginsFolder" Name="custom-integrations" />
            <Directory Id="V1NRPluginsFolder" Name="newrelic-integrations">
              <Directory Id="LoggingTool" Name="logging" />
            </Directory>
          </Directory>
        </Directory>
			</Directory>
		</Directory>
	</Fragment>

    <Fragment>
      <DirectoryRef Id="V1PluginConfigsFolder">
          <Component Id="CMP_V1_PLUGIN_CONFIGS" Guid="803C978C-B2A1-47C7-BB17-A2DE9E6D3145" KeyPath="yes">
              <CreateFolder />
          </Component>
      </DirectoryRef>
      <DirectoryRef Id="LoggingToolCfg">
          <Component Id="CMP_LOGGING_TOOL_CFG" Guid="AF0591C3-572E-4CDB-88C1-928FA97D8EFF" KeyPath="yes">
              <CreateFolder />
          </Component>
      </DirectoryRef>
      <DirectoryRef Id="V1CustomPluginsFolder">
          <Component Id="CMP_V1_CUSTOM_PLUGINS" Guid="0EE4AAF4-9923-499C-A1D0-FF55B205A76C" KeyPath="yes">
              <CreateFolder />
          </Component>
      </DirectoryRef>
      <DirectoryRef Id="LoggingTool">
          <Component Id="CMP_LOGGING_TOOL" Guid="97CBE086-FE32-44FE-B035-9B7D66A422AD" KeyPath="yes">
              <CreateFolder />
          </Component>
      </DirectoryRef>
      <DirectoryRef Id="V1NRPluginsFolder">
          <Component Id="CMP_V1_NR_PLUGINS" Guid="48198DB9-B622-49E6-B7B4-AEED7B7378DB" KeyPath="yes">
              <CreateFolder />
          </Component>
      </DirectoryRef>
    </Fragment>

	<Fragment>
		<ComponentGroup Id="ProductComponents" Directory="AgentBinaryFolder">
            <Component Id="CMP_AGENT_SERVICE_EXE" Guid="0D2CF35E-05B1-4783-B20B-B91477AC0905" Win64="yes">
                <File Id="FILE_AgentBinaryFolder_AGENT_SERVICE_EXE"
                      Name ="newrelic-infra-service.exe"
                      Source="$(var.BinariesPath)newrelic-infra-service.exe"
                      KeyPath="yes"/>
                <ServiceInstall
                  Id="InstallAgentService"
                  Name="newrelic-infra"
                  DisplayName="New Relic Infrastructure Agent"
                  Start="auto"
                  ErrorControl="normal"
                  Type="ownProcess" />
                <ServiceControl
                  Id="sc_AgentService"
                  Name="newrelic-infra"
                  Stop="both"
                  Remove="uninstall"
                  Wait="yes" />
            </Component>
            <Component Id="CMP_AGENT_EXE" Guid="4F8FF53E-B36E-4AF7-BB97-8B1AC706AE5D" Win64="yes">
                <File Id="FILE_AgentBinaryFolder_AGENT_EXE"
                      Source="$(var.BinariesPath)newrelic-infra.exe"
                      KeyPath="yes"/>
            </Component>
            <Component Id="CMP_AGENT_CONFIG_YML" Guid="A7976B53-0B30-4E9A-AEB1-C903C28A5864" Win64="yes" NeverOverwrite="yes" Permanent="yes">
                <File Id="FILE_AgentBinaryFolder_AGENT_CONFIG_YML"
                      Name="newrelic-infra.yml"
                      Source="$(var.ExternalFilesPath)newrelic-infra.windows.yml"
                      KeyPath="yes" />
            </Component>
            <Component Id="CMP_LICENSE_TXT" Guid="BA99F9AA-967F-405C-B80B-9ACE31D98E9E" Win64="yes">
                <File Id="FILE_AgentBinaryFolder_LICENSE_TXT"
                      Name ="LICENSE.txt"
                      Source="$(var.ExternalFilesPath)LICENSE.windows.txt"
                      KeyPath="yes" />
              </Component>
            <Component Id="CMP_YAMLGENERATOR_EXE" Guid="BA69F9AA-977F-415C-B70B-9ADE31D98E9F" Win64="yes">
                <File Id="FILE_AgentBinaryFolder_YAMLGENERATOR_EXE"
                     Name ="yamlgen.exe"
                     Source="$(var.BinariesPath)yamlgen.exe"
                     KeyPath="yes" />
            </Component>
            <Component Id="CMP_AGENT_CTL_EXE" Guid="A9108F57-1785-46D5-A879-D2A55AEA62F6" Win64="yes">
                  <File Id="FILE_AgentBinaryFolder_AGENT_CTL_EXE"
                        Name ="newrelic-infra-ctl.exe"
                        Source="$(var.BinariesPath)newrelic-infra-ctl.exe"
                        KeyPath="yes" />
            </Component>
		</ComponentGroup>
        <CustomAction Id="yamlgen.nribase" Property="nribase" Value="-license_key  &quot;[LICENSE_KEY]&quot; -display_name &quot;[DISPLAY_NAME]&quot; -proxy &quot;[PROXY]&quot; -custom_attributes &quot;[CUSTOM_ATTRIBUTES]&quot; " />
        <CustomAction Id="yamlgen.nriconfig0" Property="nriconfig0" Value="-metrics_system_sample_rate &quot;[METRICS_SYSTEM_SAMPLE_RATE]&quot; -metrics_storage_sample_rate &quot;[METRICS_STORAGE_SAMPLE_RATE]&quot; -metrics_network_sample_rate &quot;[METRICS_NETWORK_SAMPLE_RATE]&quot; -metrics_process_sample_rate &quot;[METRICS_PROCESS_SAMPLE_RATE]&quot;" />
        <CustomAction Id="yamlgen.nriconfig1" Property="nriconfig1" Value="-payload_compression_level &quot;[PAYLOAD_COMPRESSION_LEVEL]&quot;" />

        <CustomAction Id="RunYamlGenerator"
                Directory="AgentBinaryFolder"
                ExeCommand="[AgentBinaryFolder]yamlgen.exe [nribase] [nriconfig0] [nriconfig1]"
                Execute="deferred"
                Return="ignore"/>

       <CustomAction Id="CleanupDeprecatedBundledPlugins"
              Directory="AgentBinaryFolder"
              ExeCommand="cmd /C &quot;rmdir /s /q &quot;.\bundled-plugins&quot;&quot;"
              Execute="deferred"
              Return="ignore"
              HideTarget="no"
              Impersonate="no" />

        <InstallExecuteSequence>
            <Custom Action="yamlgen.nribase" Before="RunYamlGenerator" />
            <Custom Action="yamlgen.nriconfig0" After="yamlgen.nribase" />
            <Custom Action="yamlgen.nriconfig1" After="yamlgen.nriconfig0" />
            <Custom Action="RunYamlGenerator" Before="InstallFinalize" >
               <![CDATA[ GENERATE_CONFIG ]]>
            </Custom>
            <Custom Action="CleanupDeprecatedBundledPlugins" Before="InstallFinalize" />
        </InstallExecuteSequence>
	</Fragment>

  <Fragment>
    <ComponentGroup Id="LoggingToolComponents" Directory="LoggingTool">
        <Component Id="CMP_LOGGING_TOOL_BIN" Guid="015B10A1-7843-4961-B221-CBB449A6646C" Win64="yes">
          <File Id="FILE_LOGGING_TOOL_BIN"
              Source="$(var.BinariesPath)logging\fluent-bit.exe"
                KeyPath="yes" />
        </Component>
        <Component Id="CMP_LOGGING_TOOL_DLL" Guid="28A3B24F-A98E-4D20-BEB3-8859D29375FD" Win64="yes">
          <File Id="FILE_LOGGING_TOOL_DLL"
              Source="$(var.BinariesPath)logging\fluent-bit.dll"
                KeyPath="yes" />
        </Component>
        <Component Id="CMP_NR_LOGGING_TOOL_DLL" Guid="9B2B74F7-DA9C-4C44-9FA7-96CA3C6DBB0D" Win64="yes">
          <File Id="FILE_NR_LOGGING_TOOL_DLL"
              Source="$(var.BinariesPath)logging\out_newrelic.dll"
                KeyPath="yes" />
        </Component>
        <Component Id="CMP_NR_LOGGING_TOOL_PARSERS" Guid="34BF1E45-4AC5-45C4-AB80-D7C457A9B601" Win64="yes">
          <File Id="FILE_NR_LOGGING_TOOL_PARSERS"
              Source="$(var.BinariesPath)logging\parsers.conf"
                KeyPath="yes" />
        </Component>
    </ComponentGroup>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="LoggingToolCfgComponents" Directory="LoggingToolCfg">
        <Component Id="CMP_LOGGING_EXAMPLE_CFG_FILE" Guid="B347F18E-6406-412C-B676-B3328F285080" Win64="yes">
          <File Id="FILE_LOGGING_EXAMPLE_CFG_FILE"
              Source="$(var.ExternalFilesPath)examples\logging\windows\file.yml.example"
              KeyPath="yes" />
        </Component>
        <Component Id="CMP_LOGGING_EXAMPLE_CFG_FLUENTBIT" Guid="9CD27204-08BE-4911-BC6D-BFB01DB20897" Win64="yes">
          <File Id="FILE_LOGGING_EXAMPLE_CFG_FLUENTBIT"
              Source="$(var.ExternalFilesPath)examples\logging\windows\fluentbit.yml.example"
              KeyPath="yes" />
        </Component>
        <Component Id="CMP_LOGGING_EXAMPLE_CFG_TCP" Guid="BFCCA150-DED2-492D-9F2B-1D0F8B9A69B1" Win64="yes">
          <File Id="FILE_LOGGING_EXAMPLE_CFG_TCP"
              Source="$(var.ExternalFilesPath)examples\logging\windows\tcp.yml.example"
              KeyPath="yes" />
        </Component>
    </ComponentGroup>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="BundledPluginComponents" Directory="V1NRPluginsFolder">
        <Component Id="CMP_WINPKG_PLUGIN" Guid="DCF16A96-7A48-4B29-AD8B-9D93C7FC26B5" Win64="yes">
        <File Id="FILE_WINPKG_PLUGIN"
            Source="$(var.ExternalFilesPath)windows\amd64\winpkg\nr-winpkg.exe"
              KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="BundledPluginDefinitionComponents" Directory="V1NRPluginsFolder">
        <Component Id="CMP_WINPKG_PLUGIN_DEFINITION" Guid="E1059402-929C-4B79-AEA6-A4F2EB8B9969" Win64="yes">
        <File Id="FILE_WINPKG_PLUGIN_DEFINITION"
            Source="$(var.ExternalFilesPath)windows\amd64\winpkg\winpkg-definition.yml"
            Name="newrelic-infra-winpkg-definition.yml"
              KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="BundledPluginConfigComponents" Directory="V1PluginConfigsFolder">
	  <Component Id="CMP_WINPKG_PLUGIN_CONFIG" Guid="65E7FE69-D159-4641-B9E7-8B4B124305A5" Win64="yes">
        <File Id="FILE_WINPKG_PLUGIN_CONFIG"
            Source="$(var.ExternalFilesPath)windows\amd64\winpkg\winpkg-config.yml"
            Name="newrelic-infra-winpkg-config.yml"
              KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

</Wix>
